<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MQTT Broker Manager</title>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <h1>MQTT Broker Manager</h1>
  <div>
    <label for="nodeSelect">Select Node:</label>
    <select id="nodeSelect">
      <option value="">--Select Node--</option>
    </select>
  </div>
  <div id="log"></div>
  <div>
    <button id="waterOnButton">Water Pump ON</button>
    <button id="waterOffButton">Water Pump OFF</button>
  </div>

  <script>
    const socket = io('http://localhost:3000'); // WebSocket 서버 주소
    let selectedNode = "";

    // 노드 목록 업데이트
    socket.on('updateNodes', (nodes) => {
      const nodeSelect = document.getElementById('nodeSelect');
      nodeSelect.innerHTML = '<option value="">--Select Node--</option>';
      nodes.forEach(node => {
        const option = document.createElement('option');
        option.value = node;
        option.textContent = node;
        nodeSelect.appendChild(option);
      });
    });

    document.getElementById('nodeSelect').addEventListener('change', (event) => {
      selectedNode = event.target.value;
    });

    document.getElementById('waterOnButton').addEventListener('click', () => {
      if (selectedNode) {
        socket.emit('controlWaterPump', { nodeID: selectedNode, command: 'WATER_ON' });
      } else {
        log('Please select a node first.');
      }
    });

    document.getElementById('waterOffButton').addEventListener('click', () => {
      if (selectedNode) {
        socket.emit('controlWaterPump', { nodeID: selectedNode, command: 'WATER_OFF' });
      } else {
        log('Please select a node first.');
      }
    });

    socket.on('mqttMessage', (data) => {
      if (selectedNode === "" || data.nodeID === selectedNode) {
        log(`Message from ${data.topic}: ${data.message}`);
      }
    });

    function log(message) {
      const logDiv = document.getElementById('log');
      logDiv.innerHTML += `<p>${message}</p>`;
    }
  </script>
</body>
</html>
